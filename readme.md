# Android æ’ä»¶åŒ–å¼€å‘
## èƒŒæ™¯
ä¸Šä¸ªå‘¨ï¼Œåœ¨ç»å†äº†å››ä¸ªæœˆçš„æ¼«é•¿å¼€å‘åï¼Œæˆ‘ä»¬çš„æ–°ä¸€ç‰ˆçš„åº”ç”¨ç»ˆäºä¸Šçº¿ï¼Œç„¶è€Œï¼Œæ‚²å‰§çš„æ˜¯ä¸€ä¸Šçº¿å°±æ”¶åˆ°äº†å¾ˆä¸¥é‡çš„å´©æºƒæŠ¥å‘Šï¼Œè¿™æ—¢æœ‰å¼€å‘ä¸ç»†å¿ƒï¼Œæµ‹è¯•ä¸å…¨é¢çš„é—®é¢˜ï¼Œè¿˜æœ‰å°±æ˜¯çº¿ä¸Šä»¤äººæ‰æ‘¸ä¸å®šçš„æ•°æ®ï¼Œä»¥åŠandroidä»¤äººå‘æŒ‡çš„ç¢ç‰‡åŒ–é—®é¢˜ã€‚æ‰¯è¿œäº†ï¼Œæœ‰é—®é¢˜å°±ä¿®å‘—ï¼Œä¿®å®Œæµ‹è¯•ï¼Œæ‰“åŒ…ï¼Œå†å‘å¸ƒã€‚è´¹æ—¶è´¹åŠ›å•Šï¼Œè‹æ ¼æ‹‰åº•æ›¾ç»è¯´è¿‡ï¼šâ€œç°åœ¨ç§»åŠ¨ç«¯çš„ä¸»è¦çŸ›ç›¾æ˜¯äº§å“æ—¥ç›Šå¢é•¿çš„åŠŸèƒ½éœ€æ±‚ä¸å¹³å°è½åçš„å‘å¸ƒæµç¨‹ä¹‹é—´çš„çŸ›ç›¾â€,ğŸ˜„ã€‚<br>
è¿™ä¸ªæ—¶å€™æˆ‘ä»¬è¦æ˜¯èƒ½åƒwebä¸€æ ·çš„çƒ­æ›´æ–°å°±å¥½äº†ï¼ˆå…¶å®æ˜¯çœ¼çƒ­IOSé¡¹ç›®éƒ½å¯ä»¥éšæ—¶ä¿®bugäº†ï¼Œå†ä¹Ÿä¸ç”¨è¢«QAå«Œå¼ƒäº†ï¼‰,äº‹å®ä¸Šå‘¢å¤§å¤šæ•°æ—¶å€™å½“æˆ‘ä»¬é‡åˆ°ä¸€ä¸ªé—®é¢˜çš„æ—¶å€™ï¼Œä¹Ÿè®¸ç­”æ¡ˆå·²ç»å­˜åœ¨äº†(å¦‚æœæ²¡æœ‰æ­å–œä½ ï¼ä½ å¯èƒ½å°±æ˜¯å¼€æ‹“è€…)æ‰€ä»¥è¿™ä¸ªç­”æ¡ˆå°±æ˜¯androidæ’ä»¶åŒ–ã€‚å…¶å®ï¼Œ2015å¯ä»¥è¯´æ˜¯android æ’ä»¶åŒ–çˆ†å‘çš„ä¸€å¹´ï¼Œå› ä¸ºä¸€äº›å¤§å‹é¡¹ç›®éšç€ä¸šåŠ¡å¢é•¿ï¼Œä»£ç è¶Šæ¥è¶Šå¤š(65536æ–¹æ³•å¤©èŠ±æ¿é—®é¢˜ï¼Œæˆ‘ä»¬çš„é¡¹ç›®ç”±äºæ˜¯åœ¨åŒä¸€ä¸ªå·¥ç¨‹å®ç°ä¸¤ä¸ªå®¢æˆ·ç«¯ï¼Œæ­¤å‰å·²ç»é‡åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼Œå½“æ—¶çš„è§£å†³åŠæ³•æ˜¯å®˜æ–¹æä¾›çš„mutildexæ–¹æ¡ˆ)æ•´ä¸ªæ²Ÿé€šï¼Œå¼€å‘ï¼Œæµ‹è¯•ï¼Œæ‰“åŒ…ï¼Œéƒ¨ç½²ï¼Œåœ¨åŸæ¥çš„æ–¹å¼ä¸Šéš¾ä»¥ä¸ºç»§ï¼Œäºæ˜¯ï¼Œå›½å†…å„å¤§å…¬å¸éƒ½çº·çº·å®ç°å‡ºè‡ªå·±çš„æ’ä»¶åŒ–æ–¹æ¡ˆï¼Œå¹¶ä¸”å¼€æºå‡ºæ¥ï¼Œé€ ç¦å¹¿å¤§ç¨‹åºçŒ¿
## æ’ä»¶åŒ–çš„å¥½å¤„
1. æ¨¡å—åŒ–çš„æ–¹å¼æ›´åˆ©äºå¤§é¡¹ç›®çš„åä½œ
2. çƒ­æ›´æ–°ï¼Œçƒ­éƒ¨ç½²èƒ½åŠ›ï¼ˆäº§å“å†ä¹Ÿä¸ç”¨æ‹…å¿ƒå› ä¸ºä¿®å¤bugé¢‘ç¹å‘ç‰ˆæœ¬ï¼ŒQAå†ä¹Ÿä¸ç”¨ä¸€éåˆä¸€éçš„å›å½’äº†ï¼‰
3. ç¼–è¯‘é€Ÿåº¦çš„æå‡ã€‚å·¥ç¨‹è¢«æ‹†åˆ†ä¸ºåæ¥ä¸ªå­å·¥ç¨‹ï¼Œæ’ä»¶å•ç‹¬ç¼–è¯‘ã€‚
4. å¯åŠ¨é€Ÿåº¦æå‡ã€‚Googleæä¾›çš„MultiDexæ–¹æ¡ˆï¼Œä¼šåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œæ‰€æœ‰dexçš„è§£å‹ã€dexoptã€åŠ è½½æ“ä½œï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸æ¼«é•¿çš„è¿‡ç¨‹ï¼Œç”¨æˆ·ä¼šæ˜æ˜¾çš„çœ‹åˆ°é•¿ä¹…çš„é»‘å±ï¼Œæ›´å®¹æ˜“é€ æˆä¸»çº¿ç¨‹çš„ANRï¼Œå¯¼è‡´é¦–æ¬¡å¯åŠ¨åˆå§‹åŒ–å¤±è´¥ã€‚
5. æŒ‰éœ€åŠ è½½ï¼Œå†…å­˜å ç”¨æ›´ä½ ï¼ˆéœ€è¦å“ªä¸ªæ¨¡å—ï¼ŒåŠ è½½å“ªä¸ªæ¨¡å—ï¼‰

## æŠ€æœ¯å®ç°
æ—¢ç„¶æ’ä»¶åŒ–æœ‰è¿™ä¹ˆå¤šå¥½å¤„ï¼Œé‚£æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹è¦å®ç°æ’ä»¶åŒ–æŠ€æœ¯å±‚é¢çš„é—®é¢˜<br>
ä¼—æ‰€å‘¨çŸ¥Androidçš„è¿è¡Œæœ€ä¸ºé‡è¦çš„ä¸¤éƒ¨åˆ†å°±æ˜¯

	1.èµ„æºçš„åŠ è½½
	2.ä»£ç çš„åŠ è½½
	
**æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹Androidæ˜¯å¦‚ä½•åŠ è½½èµ„æºçš„ï¼š**<br>
é¦–å…ˆå…³æ³¨ä¸€ä¸‹é¡¹ç›®ä¸­çš„èµ„æºæ–‡ä»¶æ˜¯æ€ä¹ˆç¼–è¯‘æ‰“åŒ…çš„ï¼š<br>

é‚£äº›ç±»å‹ä¸ºres/animatorã€res/animã€res/colorã€res/drawableï¼ˆéBitmapæ–‡ä»¶ï¼Œå³é.pngã€.9.pngã€.jpgã€.gifæ–‡ä»¶ï¼‰ã€res/layoutã€res/menuã€res/valueså’Œres/xmlçš„èµ„æºæ–‡ä»¶å‡ä¼šä»æ–‡æœ¬æ ¼å¼çš„XMLæ–‡ä»¶ç¼–è¯‘æˆäºŒè¿›åˆ¶æ ¼å¼çš„XMLæ–‡ä»¶ï¼Œå¦‚å›¾1æ‰€ç¤ºï¼š<br>
![icon](./1.jpg)
ä¸ºäº†ä½¿å¾—ä¸€ä¸ªåº”ç”¨ç¨‹åºèƒ½å¤Ÿåœ¨è¿è¡Œæ—¶åŒæ—¶æ”¯æŒä¸åŒçš„å¤§å°å’Œå¯†åº¦çš„å±å¹•ï¼Œä»¥åŠæ”¯æŒå›½é™…åŒ–ï¼Œå³æ”¯æŒä¸åŒçš„å›½å®¶åœ°åŒºå’Œè¯­è¨€ï¼ŒAndroidåº”ç”¨ç¨‹åºèµ„æºçš„ç»„ç»‡æ–¹å¼æœ‰18ä¸ªç»´åº¦ï¼Œæ¯ä¸€ä¸ªç»´åº¦éƒ½ä»£è¡¨ä¸€ä¸ªé…ç½®ä¿¡æ¯ï¼Œä»è€Œå¯ä»¥ä½¿å¾—åº”ç”¨ç¨‹åºèƒ½å¤Ÿæ ¹æ®è®¾å¤‡çš„å½“å‰é…ç½®ä¿¡æ¯æ¥æ‰¾åˆ°æœ€åŒ¹é…çš„èµ„æºæ¥å±•ç°åœ¨UIä¸Šï¼Œä»è€Œæé«˜ç”¨æˆ·ä½“éªŒã€‚

ç”±äºAndroidåº”ç”¨ç¨‹åºèµ„æºçš„ç»„ç»‡æ–¹å¼å¯ä»¥è¾¾åˆ°18ä¸ªç»´åº¦ï¼Œå› æ­¤å°±è¦æ±‚Androidèµ„æºç®¡ç†æ¡†æ¶èƒ½å¤Ÿå¿«é€Ÿå®šä½æœ€åŒ¹é…è®¾å¤‡å½“å‰é…ç½®ä¿¡æ¯çš„èµ„æºæ¥å±•ç°åœ¨UIä¸Šï¼Œå¦åˆ™çš„è¯ï¼Œå°±ä¼šå½±å“ç”¨æˆ·ä½“éªŒã€‚ä¸ºäº†æ”¯æŒAndroidèµ„æºç®¡ç†æ¡†æ¶å¿«é€Ÿå®šä½æœ€åŒ¹é…èµ„æºï¼ŒAndroidèµ„æºæ‰“åŒ…å·¥å…·aaptåœ¨ç¼–è¯‘å’Œæ‰“åŒ…èµ„æºçš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ‰§è¡Œä»¥ä¸‹ä¸¤ä¸ªé¢å¤–çš„æ“ä½œï¼š

 	1. èµ‹äºˆæ¯ä¸€ä¸ªéassetsèµ„æºä¸€ä¸ªIDå€¼ï¼Œè¿™äº›IDå€¼ä»¥å¸¸é‡çš„å½¢å¼å®šä¹‰åœ¨ä¸€ä¸ªR.javaæ–‡ä»¶ä¸­ã€‚åœ¨Rç±»ä¸­ç”Ÿæˆçš„æ¯ä¸€ä¸ªintå‹å››å­—èŠ‚èµ„æºIDï¼Œå®é™…ä¸Šéƒ½ç”±ä¸‰ä¸ªå­—æ®µç»„æˆã€‚ç¬¬ä¸€å­—èŠ‚ä»£è¡¨äº†Packageï¼Œç¬¬äºŒå­—èŠ‚ä¸ºåˆ†ç±»ï¼Œä¸‰å››å­—èŠ‚ä¸ºç±»å†…ID

    2. ç”Ÿæˆä¸€ä¸ªresources.arscæ–‡ä»¶ï¼Œç”¨æ¥æè¿°é‚£äº›å…·æœ‰IDå€¼çš„èµ„æºçš„é…ç½®ä¿¡æ¯ï¼Œå®ƒçš„å†…å®¹å°±ç›¸å½“äºæ˜¯ä¸€ä¸ªèµ„æºç´¢å¼•è¡¨ã€‚

æœ‰äº†èµ„æºIDä»¥åŠèµ„æºç´¢å¼•è¡¨ä¹‹åï¼ŒAndroidèµ„æºç®¡ç†æ¡†æ¶å°±å¯ä»¥è¿…é€Ÿå°†æ ¹æ®è®¾å¤‡å½“å‰é…ç½®ä¿¡æ¯æ¥å®šä½æœ€åŒ¹é…çš„èµ„æºäº†ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åœ¨åˆ†æAndroidåº”ç”¨ç¨‹åºèµ„æºçš„ç¼–è¯‘å’Œæ‰“åŒ…è¿‡ç¨‹ä¸­ï¼Œå°±ä¸»è¦å…³æ³¨XMLèµ„æºçš„ç¼–è¯‘è¿‡ç¨‹ã€èµ„æºIDæ–‡ä»¶R.javaçš„ç”Ÿæˆè¿‡ç¨‹ä»¥åŠèµ„æºç´¢å¼•è¡¨æ–‡ä»¶resources.arscçš„ç”Ÿæˆè¿‡ç¨‹ã€‚

Androidèµ„æºæ‰“åŒ…å·¥å…·åœ¨ç¼–è¯‘åº”ç”¨ç¨‹åºèµ„æºä¹‹å‰ï¼Œä¼šåˆ›å»ºä¸€ä¸ªèµ„æºè¡¨ã€‚è¿™ä¸ªèµ„æºè¡¨ä½¿ç”¨ä¸€ä¸ªResourceTableå¯¹è±¡æ¥æè¿°ï¼Œå½“åº”ç”¨ç¨‹åºèµ„æºç¼–è¯‘å®Œæˆä¹‹åï¼Œå®ƒå°±ä¼šåŒ…å«æ‰€æœ‰èµ„æºçš„ä¿¡æ¯ã€‚æœ‰äº†è¿™ä¸ªèµ„æºè¡¨ä¹‹åï¼Œ Androidèµ„æºæ‰“åŒ…å·¥å…·å°±å¯ä»¥æ ¹æ®å®ƒçš„å†…å®¹æ¥ç”Ÿæˆèµ„æºç´¢å¼•è¡¨æ–‡ä»¶resources.arscäº†ã€‚

<br>
å¥½äº†ï¼Œèµ„æºçš„ç”Ÿæˆç‹—å¶æˆå·²ç»äº†è§£æˆ‘ä»¬åœ¨çœ‹ä¸€ä¸‹èµ„æºçš„åŠ è½½
åœ¨androidä¸­éƒ½ä¼šè°ƒç”¨`getReSource()`æ–¹æ³•æ¥åŠ è½½èµ„æº


å…ˆçœ‹ä¸€ä¸‹Resourceç±»

	public Resources(AssetManager assets, DisplayMetrics metrics, Configuration config,
            CompatibilityInfo compatInfo, IBinder token) {
        mAssets = assets;
        mMetrics.setToDefaults();
        if (compatInfo != null) {
            mCompatibilityInfo = compatInfo;
        }
        mToken = new WeakReference<IBinder>(token);
        updateConfiguration(config, metrics);
        assets.ensureStringBlocks();
    }
    
    
   çœ‹åˆ°å…¶å®æ˜¯ä»£ç†ç»™äº†AssetManager çš„`ensureStringBlocks()`æ¥ç€å¾€ä¸‹çœ‹
   	
   	  /*package*/ final void ensureStringBlocks() {
        if (mStringBlocks == null) {
            synchronized (this) {
                if (mStringBlocks == null) {
                    makeStringBlocks(sSystem.mStringBlocks);
                }
            }
        }
    }
    
    
  å‡½æ•°å…ˆåˆ¤æ–­mStringBlockså˜é‡æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºçš„è¯ï¼Œè¡¨ç¤ºéœ€è¦è¢«åˆå§‹åŒ–ï¼Œäºæ˜¯è°ƒç”¨makeStringBlockså‡½æ•°åˆå§‹åŒ–mStringBlocks:
  
  	/*package*/ final void makeStringBlocks(StringBlock[] seed) {
    final int seedNum = (seed != null) ? seed.length : 0;
    final int num = getStringBlockCount();
    mStringBlocks = new StringBlock[num];
    if (localLOGV) Log.v(TAG, "Making string blocks for " + this
            + ": " + num);
    for (int i=0; i<num; i++) {
        if (i < seedNum) {
            mStringBlocks[i] = seed[i];
        } else {
            mStringBlocks[i] = new StringBlock(getNativeStringBlock(i), true);
        }
    }
	}


è¿™é‡Œçš„mStringBlockså¯¹è±¡æ˜¯ä¸€ä¸ªStringBlockæ•°ç»„ï¼Œè¿™ä¸ªç±»è¢«æ ‡è®°ä¸º@hideï¼Œè¡¨ç¤ºåº”ç”¨å±‚æ ¹æœ¬ä¸éœ€è¦å…³å¿ƒå®ƒçš„å­˜åœ¨ã€‚é‚£ä¹ˆå®ƒæ˜¯åšä»€ä¹ˆç”¨çš„å‘¢ï¼Œå®ƒå°±æ˜¯AssetManagerèƒ½å¤Ÿè®¿é—®èµ„æºçš„å¥¥ç§˜æ‰€åœ¨ï¼ŒAssetManageræ‰€æœ‰è®¿é—®èµ„æºçš„å‡½æ•°ï¼Œä¾‹å¦‚getResourceTextArray()ï¼Œéƒ½æœ€ç»ˆé€šè¿‡StringBlockå†ä»£ç†åˆ°nativeè¿›è¡Œè®¿é—®çš„ã€‚çœ‹åˆ°è¿™é‡Œï¼Œä¾ç„¶æ²¡æœ‰ä»»ä½•çœ‹åˆ°èƒ½å¤ŸæŒ‡ç¤ºä¸ºä»€ä¹ˆå¼€å‘è€…å¯ä»¥è®¿é—®è‡ªå·±åº”ç”¨çš„èµ„æºï¼Œé‚£ä¹ˆæˆ‘ä»¬å†çœ‹å¾—å‰é¢ä¸€ç‚¹ï¼Œçœ‹çœ‹ä¼ å…¥Resourcesçš„æ„é€ å‡½æ•°ä¹‹å‰ï¼Œassetå‚æ•°æ˜¯ä¸æ˜¯è¢«â€œåšè¿‡æ‰‹è„šâ€ã€‚å‡½æ•°è°ƒç”¨è¾—è½¬åˆ°ResourceManagerçš„getTopLevelResourceså‡½æ•°:

	/**
     * Creates the top level Resources for applications with the given compatibility info.
     *
     * @param resDir the resource directory.
     * @param overlayDirs the resource overlay directories.
     * @param libDirs the shared library resource dirs this app references.
     * @param compatInfo the compability info. Must not be null.
     * @param token the application token for determining stack bounds.
     */
    public Resources getTopLevelResources(String resDir, String[] splitResDirs,
            String[] overlayDirs, String[] libDirs, int displayId,
            Configuration overrideConfiguration, CompatibilityInfo compatInfo, IBinder token) {
            â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦
            
            if (resDir != null) {
            if (assets.addAssetPath(resDir) == 0) {
                return null;
            }
        }
        
        â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦
    }
    
  å‡½æ•°ä»£ç æœ‰ç‚¹å¤šï¼Œæˆªå–æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œé‚£å°±æ˜¯ç³»ç»Ÿé€šè¿‡è°ƒç”¨AssetManagerçš„addAssetPathå‡½æ•°ï¼Œå°†éœ€è¦åŠ è½½çš„èµ„æºè·¯å¾„åŠ äº†è¿›å»ã€‚
  
  	 public final int addAssetPath(String path) {
        synchronized (this) {
            int res = addAssetPathNative(path);
            makeStringBlocks(mStringBlocks);
            return res;
        }
    }

    private native final int addAssetPathNative(String path);
  
  addAssetPathå‡½æ•°è¿”å›ä¸€ä¸ªintç±»å‹ï¼Œå®ƒæŒ‡ç¤ºäº†æ¯ä¸ªè¢«æ·»åŠ çš„èµ„æºè·¯å¾„åœ¨nativeå±‚ä¸€ä¸ªæ•°ç»„ä¸­çš„ä½ç½®ï¼Œè¿™ä¸ªæ•°ç»„ä¿å­˜äº†ç³»ç»Ÿèµ„æºè·¯å¾„(framework-res.apk)ï¼Œå’Œåº”ç”¨è‡ªå·±æ·»åŠ çš„æ‰€æœ‰çš„èµ„æºè·¯å¾„ã€‚å†å›è¿‡å¤´çœ‹makeStringBlockså‡½æ•°ï¼Œå°±è±ç„¶å¼€æœ—äº†ï¼š
  
  	1. makeStringBlockså‡½æ•°çš„å‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ªStringBlockæ•°ç»„ï¼Œå®ƒè¡¨ç¤ºç³»ç»Ÿèµ„æºï¼Œé¦–å…ˆå®ƒè°ƒç”¨getStringBlockCountå‡½æ•°å¾—åˆ°å½“å‰åº”ç”¨æ‰€æœ‰è¦åŠ è½½çš„èµ„æºè·¯å¾„æ•°é‡ã€‚
 	2. ç„¶åè¿›å…¥å¾ªç¯ï¼Œå¦‚æœå±äºç³»ç»Ÿèµ„æºï¼Œå°±ç›´æ¥ç”¨ä¼ å…¥å‚æ•°seedä¸­çš„å¯¹è±¡æ¥èµ‹å€¼ã€‚
	3. å¦‚æœæ˜¯åº”ç”¨è‡ªå·±çš„èµ„æºï¼Œå°±å®ä¾‹åŒ–ä¸€ä¸ªæ–°çš„StringBlockå¯¹è±¡æ¥èµ‹å€¼ã€‚å¹¶åœ¨StringBlockçš„æ„é€ å‡½æ•°ä¸­è°ƒç”¨getNativeStringBlockå‡½æ•°æ¥è·å–ä¸€ä¸ªnativeå±‚çš„å¯¹è±¡æŒ‡é’ˆï¼Œè¿™ä¸ªæŒ‡é’ˆè¢«javaå±‚StringBlockå¯¹è±¡ç”¨æ¥è°ƒç”¨nativeå‡½æ•°ï¼Œæœ€ç»ˆè¾¾åˆ°è®¿é—®èµ„æºçš„ç›®çš„ã€‚
	
**æˆ‘ä»¬åªéœ€åå°„è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œç„¶åæŠŠæ’ä»¶apkçš„ä½ç½®å‘Šè¯‰AssetManagerç±»ï¼Œå®ƒå°±ä¼šæ ¹æ®æ’ä»¶apkå†…çš„resources.arscå’Œå·²ç¼–è¯‘èµ„æºå®Œæˆèµ„æºåŠ è½½çš„ä»»åŠ¡äº†ã€‚**


**ç¬¬äºŒæ­¥å°±éœ€è¦çœ‹çœ‹æ€ä¹ˆåŠ è½½ç±»æ–‡ä»¶äº†**<br>
åœ¨Androidé¡¹ç›®ä¸­ï¼Œæ‰€æœ‰çš„javaä»£ç æœ€ç»ˆéƒ½ä¼šç»è¿‡SDKçš„DXå·¥å…·æŠŠ.jaræ–‡ä»¶ä¼˜åŒ–æˆ.dexæ–‡ä»¶ï¼ˆåœ¨â€œandroid-sdk\build-tools\å…·ä½“ç‰ˆæœ¬\â€è·¯å¾„ä¸‹ï¼‰ã€‚é‚£ä¹ˆè¿è¡Œä»£ç ä¹Ÿå°±æ˜¯è¿è¡Œdexæ–‡ä»¶äº†ã€‚<br>
æˆ‘ä»¬ä»googleå®˜æ–¹çš„çš„mutilDexçš„è§£å†³åŠæ³•ä¸­å¯ä»¥çœ‹åˆ°ï¼š
	
	public class MultiDexApplication extends Application {
  		@Override
  		protected void attachBaseContext(Context base) {
    		super.attachBaseContext(base);
    		MultiDex.install(this);
  		}
	}
	
åœ¨mutilDexä¸­

	private static void install(ClassLoader loader, List<File> additionalClassPathEntries,
     File optimizedDirectory)
             throws IllegalArgumentException, IllegalAccessException,
             NoSuchFieldException, InvocationTargetException, NoSuchMethodException {
    /* The patched class loader is expected to be a descendant of
    * dalvik.system.BaseDexClassLoader. We modify its
    * dalvik.system.DexPathList pathList field to append additional DEX
    * file entries.
    */
    Field pathListField = findField(loader, "pathList");
    Object dexPathList = pathListField.get(loader);
    expandFieldArray(dexPathList, "dexElements", makeDexElements(dexPathList,
         new ArrayList<File>(additionalClassPathEntries), optimizedDirectory));
	}



å¯ä»¥çœ‹å‡ºä»–æ˜¯é€šè¿‡classLoaderæ¥åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶çš„ã€‚

Androidçš„è™šæ‹Ÿæœºä¸èƒ½ç”¨ClassCloadç›´æ¥åŠ è½½.dexï¼Œè€Œæ˜¯è¦ç”¨DexClassLoaderæˆ–è€…PathClassLoader,ä»–ä»¬éƒ½æ˜¯ClassLoaderçš„å­ç±»ï¼Œè¿™ä¸¤è€…çš„åŒºåˆ«æ˜¯

1. DexClassLoaderï¼šå¯ä»¥åŠ è½½jar/apk/dexï¼Œå¯ä»¥ä»SDå¡ä¸­åŠ è½½æœªå®‰è£…çš„apkï¼›
2. PathClassLoaderï¼šè¦ä¼ å…¥ç³»ç»Ÿä¸­apkçš„å­˜æ”¾Pathï¼Œæ‰€ä»¥åªèƒ½åŠ è½½å·²ç»å®‰è£…çš„apkæ–‡ä»¶ï¼›

æ˜¾ç„¶æˆ‘ä»¬è¦åŠ åœ¨æ’ä»¶ä¸­çš„ç±»æ˜¯æœªå®‰è£…çš„ï¼Œé‚£å°±å»çœ‹çœ‹DexClassLoaderï¼š
	
	public DexClassLoader(String dexPath, String optimizedDirectory, String libraryPath, ClassLoader parent) {
        super((String)null, (File)null, (String)null, (ClassLoader)null);
        throw new RuntimeException("Stub!");
    }
    
    
æˆ‘ä»¬ä¹‹å‰æåˆ°çš„ï¼ŒDexClassLoaderå¹¶ä¸èƒ½ç›´æ¥åŠ è½½å¤–éƒ¨å­˜å‚¨çš„.dexæ–‡ä»¶ï¼Œè€Œæ˜¯è¦å…ˆæ‹·è´åˆ°å†…éƒ¨å­˜å‚¨é‡Œã€‚è¿™é‡Œçš„dexPathå°±æ˜¯.dexçš„å¤–éƒ¨å­˜å‚¨è·¯å¾„ï¼Œè€ŒoptimizedDirectoryåˆ™æ˜¯å†…éƒ¨è·¯å¾„ï¼ŒlibraryPathç”¨nullå³å¯ï¼Œparentåˆ™æ˜¯è¦ä¼ å…¥å½“å‰åº”ç”¨çš„ClassLoaderï¼Œè¿™ä¸ClassLoaderçš„â€œåŒäº²ä»£ç†æ¨¡å¼â€æœ‰å…³.[ClassLoaderåŒäº²æ¨¡å¼å‚è€ƒ](https://segmentfault.com/a/1190000004062880)

å®é™…ä½¿ç”¨å¦‚ä¸‹ï¼š

	File optimizedDexOutputPath = new File(Environment.getExternalStorageDirectory().getAbsolutePath() + File.separator + "test_dexloader.jar");// å¤–éƒ¨è·¯å¾„
	File dexOutputDir = this.getDir("dex", 0);// æ— æ³•ç›´æ¥ä»å¤–éƒ¨è·¯å¾„åŠ è½½.dexæ–‡ä»¶ï¼Œéœ€è¦æŒ‡å®šAPPå†…éƒ¨è·¯å¾„ä½œä¸ºç¼“å­˜ç›®å½•ï¼ˆ.dexæ–‡ä»¶ä¼šè¢«è§£å‹åˆ°æ­¤ç›®å½•ï¼‰
	DexClassLoader dexClassLoader = new 	DexClassLoader(optimizedDexOutputPath.getAbsolutePath(),dexOutputDir.getAbsolutePath(), null, getClassLoader());
	
**è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å°†Dexæ–‡ä»¶åŠ è½½è¿›æ¥äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¦‚ä½•è°ƒç”¨dexä¸­çš„ä»£ç å•¦ï¼š**

ä½¿ç”¨DexClassLoaderåŠ è½½è¿›æ¥çš„ç±»ï¼Œæˆ‘ä»¬æœ¬åœ°å¹¶æ²¡æœ‰è¿™äº›ç±»çš„æºç ï¼Œæ‰€ä»¥æ— æ³•ç›´æ¥è°ƒç”¨ï¼Œä¸è¿‡å¯ä»¥é€šè¿‡åå°„çš„æ–¹æ³•è°ƒç”¨ï¼Œç®€å•ç²—æš´ã€‚

	DexClassLoader dexClassLoader = new DexClassLoader(optimizedDexOutputPath.getAbsolutePath(), dexOutputDir.getAbsolutePath(), null, getClassLoader());
            Class libProviderClazz = null;
            try {
                libProviderClazz = dexClassLoader.loadClass("me.kaede.dexclassloader.MyLoader");
                // éå†ç±»é‡Œæ‰€æœ‰æ–¹æ³•
                Method[] methods = libProviderClazz.getDeclaredMethods();
                for (int i = 0; i < methods.length; i++) {
                    Log.e(TAG, methods[i].toString());
                }
                Method start = libProviderClazz.getDeclaredMethod("func");// è·å–æ–¹æ³•
                start.setAccessible(true);// æŠŠæ–¹æ³•è®¾ä¸ºpublicï¼Œè®©å¤–éƒ¨å¯ä»¥è°ƒç”¨
                String string = (String) start.invoke(libProviderClazz.newInstance());// è°ƒç”¨æ–¹æ³•å¹¶è·å–è¿”å›å€¼
                Toast.makeText(this, string, Toast.LENGTH_LONG).show();
            } catch (Exception exception) {
                // Handle exception gracefully here.
                exception.printStackTrace();
            }

æ¥ä¸‹æ¥æˆ‘ä»¬è¦è€ƒè™‘ä¸€ä¸‹ä¸‹`android 5.0`çš„å…¼å®¹æ¨¡å¼äº†ï¼Œå› ä¸º5.0ä¹‹åandroidç±»åŠ è½½çš„æ–¹å¼æ”¹ä¸ºäº†`ART`æ¨¡å¼.

å…¶å®ï¼ŒARTæ¨¡å¼ç›¸æ¯”åŸæ¥çš„Dalvikï¼Œä¼šåœ¨å®‰è£…APKçš„æ—¶å€™ï¼Œä½¿ç”¨Androidç³»ç»Ÿè‡ªå¸¦çš„dex2oatå·¥å…·æŠŠAPKé‡Œé¢çš„.dexæ–‡ä»¶è½¬åŒ–æˆOATæ–‡ä»¶ï¼ŒOATæ–‡ä»¶æ˜¯ä¸€ç§Androidç§æœ‰ELFæ–‡ä»¶æ ¼å¼ï¼Œå®ƒä¸ä»…åŒ…å«æœ‰ä»DEXæ–‡ä»¶ç¿»è¯‘è€Œæ¥çš„æœ¬åœ°æœºå™¨æŒ‡ä»¤ï¼Œè¿˜åŒ…å«æœ‰åŸæ¥çš„DEXæ–‡ä»¶å†…å®¹ã€‚è¿™ä½¿å¾—æˆ‘ä»¬æ— éœ€é‡æ–°ç¼–è¯‘åŸæœ‰çš„APKå°±å¯ä»¥è®©å®ƒæ­£å¸¸åœ°åœ¨ARTé‡Œé¢è¿è¡Œï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸éœ€è¦æ”¹å˜åŸæ¥çš„APKç¼–ç¨‹æ¥å£ã€‚ARTæ¨¡å¼çš„ç³»ç»Ÿé‡Œï¼ŒåŒæ ·å­˜åœ¨DexClassLoaderç±»ï¼ŒåŒ…åè·¯å¾„ä¹Ÿæ²¡å˜ï¼Œåªä¸è¿‡å®ƒçš„å…·ä½“å®ç°ä¸åŸæ¥çš„æœ‰æ‰€ä¸åŒï¼Œä½†æ˜¯æ¥å£æ˜¯ä¸€è‡´çš„ã€‚



	public class DexClassLoader extends BaseDexClassLoader {
    	public DexClassLoader(String dexPath, String optimizedDirectory, String libraryPath, ClassLoader parent) {
        	super((String)null, (File)null, (String)null, (ClassLoader)null);
        	throw new RuntimeException("Stub!");
    	}
	}

ä¹Ÿå°±æ˜¯è¯´ï¼ŒARTæ¨¡å¼åœ¨åŠ è½½.dexæ–‡ä»¶çš„æ–¹æ³•ä¸Šï¼Œå¯¹Dalvikåšäº†å‘ä¸‹å…¼å®¹ï¼Œæ‰€ä»¥ä½¿ç”¨DexClassLoaderåŠ è½½è¿›æ¥çš„.dexæ–‡ä»¶åŒæ ·ä¹Ÿä¼šè¢«è½¬åŒ–æˆOATæ–‡ä»¶å†è¢«æ‰§è¡Œï¼Œâ€œä»¥DexClassLoaderä¸ºæ ¸å¿ƒçš„åŠ¨æ€åŠ è½½æ–¹æ¡ˆâ€åœ¨ARTæ¨¡å¼ä¸Šå¯ä»¥ç¨³å®šè¿è¡Œã€‚


å¥½äº†ï¼Œè‡³æ­¤å„ä½çœ‹å®¢ä¸€å®šä»¥ä¸ºå¤§åŠŸå‘Šæˆï¼Œç„¶è€Œä¸€å±±è¿˜æ¯”ä¸€å±±é«˜ï¼Œä¸€å‘è¿˜æ¯”ä¸€å‘éš¾å•Šï¼Œ**å¦‚ä½•ç®¡ç†activtyçš„ç”Ÿå‘½å‘¨æœŸ**å°±æ˜¯æ¥ä¸‹æ¥çš„éš¾é¢˜ã€‚

é€šè¿‡ClassLoaderåŠ è½½å¹¶å®ä¾‹åŒ–çš„Activityå®ä¾‹åªæ˜¯ä¸€ä¸ªæ™®é€šçš„Javaå¯¹è±¡ï¼Œèƒ½è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•ï¼Œä½†æ˜¯å®ƒæ²¡æœ‰ç”Ÿå‘½å‘¨æœŸï¼Œè€Œä¸”Activityç­‰ç³»ç»Ÿç»„ä»¶æ˜¯éœ€è¦Androidçš„ä¸Šä¸‹æ–‡ç¯å¢ƒçš„ï¼ˆContextç­‰èµ„æºï¼‰ï¼Œæ²¡æœ‰è¿™äº›ä¸œè¥¿Activityæ ¹æœ¬æ— æ³•å·¥ä½œ<br>

æˆ‘ä»¬åœ¨æ­£å¸¸å¼€å‘ä¸€ä¸ªåº”ç”¨çš„æ—¶å€™å¿…é¡»æŠŠä½¿ç”¨åˆ°çš„activityï¼Œæ³¨å†Œåˆ°é¡¹ç›®çš„AndroidManifest.xmlä¸­ï¼Œè¿™æ ·åœ¨åº”ç”¨è¢«å®‰è£…å’Œå¯åŠ¨åˆ°çš„æ—¶å€™èƒ½å¤Ÿæ‰¾åˆ°è¿™ä¸ªç±»,å¹¶ä¸”ç»´æŠ¤èµ·ç”Ÿå‘½å‘¨æœŸä»¥åŠä¸Šä¸‹æ–‡å˜é‡ï¼Œå…·ä½“è¯¦ç»†æ­¥éª¤è¯·ç§»æ­¥å¤§ç¥è€ç½—çš„[Androidåº”ç”¨ç¨‹åºå¯åŠ¨è¿‡ç¨‹æºä»£ç åˆ†æ](http://blog.csdn.net/luoshengyang/article/details/6689748)

è¿™é‡Œé¢é‡ç‚¹å…³æ³¨ï¼š

	   Activity activity = null;
  	   try {
			java.lang.ClassLoader cl = r.packageInfo.getClassLoader();
			activity = mInstrumentation.newActivity(
			cl, component.getClassName(), r.intent);
			r.intent.setExtrasClassLoader(cl);
			if (r.state != null) {
				r.state.setClassLoader(cl);
		}
   	} catch (Exception e) {
		......
   	}		  

å’Œ

	   mInstrumentation.callActivityOnCreate(activity, r.state);
	   
å¯è§å…¶ç”Ÿå‘½å‘¨æœŸå‘¨æœŸéƒ½æ˜¯ç”±`mInstrumentation`æ¥ç®¡ç†çš„ï¼Œ è¿™é‡Œçš„mInstrumentationæ˜¯Activityç±»çš„æˆå‘˜å˜é‡ï¼Œå®ƒçš„ç±»å‹æ˜¯Intrumentationï¼Œå®šä¹‰åœ¨frameworks/base/core/java/android/app/Instrumentation.javaæ–‡ä»¶ä¸­ï¼Œå®ƒç”¨æ¥ç›‘æ§åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿçš„äº¤äº’ã€‚
æˆ‘ä»¬æ˜¯ä¸èƒ½æ”¹åŠ¨å’Œè·å–çš„ã€‚

å¯èƒ½æœ‰äººè¯´ï¼Œé‚£æˆ‘ä»¬ç›´æ¥æŠŠéœ€è¦çš„activityï¼Œç›´æ¥äº‹å…ˆæ³¨å†Œåœ¨ä¸»é¡¹ç›®ä¸­å•Šï¼Œé‚£æˆ‘ä»¬å²‚ä¸æ˜¯æœ¬æœ«å€’ç½®äº†ã€‚
æ‰€ä»¥å°±æœ‰äººç ”ç©¶å‡ºäº†æ›´å¥½çš„åŠæ³•ï¼š

**1 ä»£ç†Activity æ¨¡å¼**

ç”Ÿå‘½å‘¨æœŸä¸å°±æ˜¯ç³»ç»Ÿå¯¹Activityä¸€äº›ç‰¹å®šæ–¹æ³•çš„è°ƒç”¨å˜›ï¼Œé‚£æˆ‘ä»¬å¯ä»¥åœ¨ä¸»é¡¹ç›®é‡Œåˆ›å»ºä¸€ä¸ªProxyActivityï¼Œå†ç”±å®ƒå»ä»£ç†è°ƒç”¨æ’ä»¶Activityçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼ˆè¿™ä¹Ÿæ˜¯ä»£ç†æ¨¡å¼å«æ³•çš„ç”±æ¥ï¼‰ã€‚ç”¨ProxyActivityï¼ˆä¸€ä¸ªæ ‡å‡†çš„Activityå®ä¾‹ï¼‰çš„ç”Ÿå‘½å‘¨æœŸåŒæ­¥æ§åˆ¶æ’ä»¶Activityï¼ˆæ™®é€šç±»çš„å®ä¾‹ï¼‰çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒæ­¥çš„æ–¹å¼å¯ä»¥æœ‰ä¸‹é¢ä¸¤ç§ï¼š

1. åœ¨ProxyActivityç”Ÿå‘½å‘¨æœŸé‡Œç”¨åå°„è°ƒç”¨æ’ä»¶Activityç›¸åº”ç”Ÿå‘½å‘¨æœŸçš„æ–¹æ³•ï¼Œç®€å•ç²—æš´ã€‚
2. æŠŠæ’ä»¶Activityçš„ç”Ÿå‘½å‘¨æœŸæŠ½è±¡æˆæ¥å£ï¼Œåœ¨ProxyActivityçš„ç”Ÿå‘½å‘¨æœŸé‡Œè°ƒç”¨ã€‚å¦å¤–ï¼Œå¤šäº†è¿™ä¸€å±‚æ¥å£ï¼Œä¹Ÿæ–¹ä¾¿ä¸»é¡¹ç›®æ§åˆ¶æ’ä»¶Activityã€‚

**2 åŠ¨æ€åˆ›å»ºActivityæ¨¡å¼ ï¼ˆé»‘ç§‘æŠ€æœ‰æœ¨æœ‰ï¼‰**

ä½¿ç”¨ä»£ç†Activityèƒ½å¤Ÿè§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œä½†æ˜¯æœ‰ä¸€äº›é™åˆ¶

1. å®é™…è¿è¡Œçš„Activityå®ä¾‹å…¶å®éƒ½æ˜¯ProxyActivityï¼Œå¹¶ä¸æ˜¯çœŸæ­£æƒ³è¦å¯åŠ¨çš„Activityï¼›
2. ProxyActivityåªèƒ½æŒ‡å®šä¸€ç§LaunchModeï¼Œæ‰€ä»¥æ’ä»¶é‡Œçš„Activityæ— æ³•è‡ªå®šä¹‰LaunchModeï¼›
3. ä¸æ”¯æŒé™æ€æ³¨å†Œçš„BroadcastReceiverï¼›
å¾€å¾€ä¸æ˜¯æ‰€æœ‰çš„apkéƒ½å¯ä½œä¸ºæ’ä»¶è¢«åŠ è½½ï¼Œæ’ä»¶é¡¹ç›®éœ€è¦ä¾èµ–ç‰¹å®šçš„æ¡†æ¶ï¼Œè¿˜æœ‰éœ€è¦éµå¾ªä¸€å®šçš„"å¼€å‘è§„èŒƒ"ï¼›
4. ç‰¹åˆ«æ˜¯æœ€åä¸€ä¸ªï¼Œæ— æ³•ç›´æ¥æŠŠä¸€ä¸ªæ™®é€šçš„APKä½œä¸ºæ’ä»¶ä½¿ç”¨ã€‚æ€ä¹ˆé¿å¼€è¿™äº›é™åˆ¶å‘¢ï¼Ÿæ’ä»¶çš„Activityä¸æ˜¯æ ‡å‡†çš„Activityå¯¹è±¡æ‰ä¼šæœ‰è¿™äº›é™åˆ¶ï¼Œä½¿å…¶æˆä¸ºæ ‡å‡†çš„Activityæ˜¯è§£å†³é—®é¢˜çš„å…³é”®ï¼Œè€Œè¦ä½¿å…¶æˆä¸ºæ ‡å‡†çš„Activityï¼Œåˆ™éœ€è¦åœ¨ä¸»é¡¹ç›®é‡Œæ³¨å†Œè¿™äº›Activityã€‚


è¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºå¹¶ç¼–è¯‘ä¸€ä¸ªActivityç±»ï¼Œè¿™ç§æƒ³æ³•ä¸æ˜¯å¤©æ–¹å¤œè°­ï¼ŒåŠ¨æ€åˆ›å»ºç±»çš„å·¥å…·æœ‰dexmakerå’Œasmdexï¼ŒäºŒè€…å‡èƒ½å®ç°åŠ¨æ€å­—èŠ‚ç æ“ä½œï¼Œæœ€å¤§çš„åŒºåˆ«æ˜¯å‰è€…æ˜¯åˆ›å»ºdexæ–‡ä»¶ï¼Œè€Œåè€…æ˜¯åˆ›å»ºclassæ–‡ä»¶ã€‚

	public class MainActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
    }

    public void onMakeDex(View view){
        try {
            DexMaker dexMaker = new DexMaker();
            // Generate a HelloWorld class.
            TypeId<?> helloWorld = TypeId.get("LHelloWorld;");
            dexMaker.declare(helloWorld, "HelloWorld.generated", Modifier.PUBLIC, TypeId.OBJECT);
            generateHelloMethod(dexMaker, helloWorld);
            // Create the dex file and load it.
            File outputDir = new File(Environment.getExternalStorageDirectory() + File.separator + "dexmaker");
            if (!outputDir.exists())outputDir.mkdir();
            ClassLoader loader = dexMaker.generateAndLoad(this.getClassLoader(), outputDir);
            Class<?> helloWorldClass = loader.loadClass("HelloWorld");
            // Execute our newly-generated code in-process.
            helloWorldClass.getMethod("hello").invoke(null);
        } catch (Exception e) {
            Log.e("MainActivity","[onMakeDex]",e);
        }
    }

    /**
     * Generates Dalvik bytecode equivalent to the following method.
     *    public static void hello() {
     *        int a = 0xabcd;
     *        int b = 0xaaaa;
     *        int c = a - b;
     *        String s = Integer.toHexString(c);
     *        System.out.println(s);
     *        return;
     *    }
     */
    private static void generateHelloMethod(DexMaker dexMaker, TypeId<?> declaringType) {
        // Lookup some types we'll need along the way.
        TypeId<System> systemType = TypeId.get(System.class);
        TypeId<PrintStream> printStreamType = TypeId.get(PrintStream.class);

        // Identify the 'hello()' method on declaringType.
        MethodId hello = declaringType.getMethod(TypeId.VOID, "hello");

        // Declare that method on the dexMaker. Use the returned Code instance
        // as a builder that we can append instructions to.
        Code code = dexMaker.declare(hello, Modifier.STATIC | Modifier.PUBLIC);

        // Declare all the locals we'll need up front. The API requires this.
        Local<Integer> a = code.newLocal(TypeId.INT);
        Local<Integer> b = code.newLocal(TypeId.INT);
        Local<Integer> c = code.newLocal(TypeId.INT);
        Local<String> s = code.newLocal(TypeId.STRING);
        Local<PrintStream> localSystemOut = code.newLocal(printStreamType);

        // int a = 0xabcd;
        code.loadConstant(a, 0xabcd);

        // int b = 0xaaaa;
        code.loadConstant(b, 0xaaaa);

        // int c = a - b;
        code.op(BinaryOp.SUBTRACT, c, a, b);

        // String s = Integer.toHexString(c);
        MethodId<Integer, String> toHexString
                = TypeId.get(Integer.class).getMethod(TypeId.STRING, "toHexString", TypeId.INT);
        code.invokeStatic(toHexString, s, c);

        // System.out.println(s);
        FieldId<System, PrintStream> systemOutField = systemType.getField(printStreamType, "out");
        code.sget(systemOutField, localSystemOut);
        MethodId<PrintStream, Void> printlnMethod = printStreamType.getMethod(
                TypeId.VOID, "println", TypeId.STRING);
        code.invokeVirtual(printlnMethod, null, localSystemOut, s);

        // return;
        code.returnVoid();
   	 }
    
	}
è¿è¡Œååœ¨SDå¡çš„dexmakerç›®å½•ä¸‹æ‰¾åˆ°åˆšåˆ›å»ºçš„æ–‡ä»¶â€œGenerated1532509318.jarâ€ï¼ŒæŠŠé‡Œé¢çš„â€œclasses.dexâ€è§£å‹å‡ºæ¥ï¼Œç„¶åå†ç”¨â€œdex2jarâ€å·¥å…·è½¬åŒ–æˆjaræ–‡ä»¶ï¼Œæœ€åå†ç”¨â€œjd-guiâ€å·¥å…·åç¼–è¯‘jarçš„æºç ã€‚

![icon](./2.png)


æ¥ä¸‹æ¥çš„é—®é¢˜æ˜¯å¦‚ä½•æŠŠéœ€è¦å¯åŠ¨çš„ã€åœ¨Manifesté‡Œé¢æ²¡æœ‰æ³¨å†Œçš„PlugActivityæ¢æˆæœ‰æ³¨å†Œçš„TargetActivityã€‚

åœ¨Androidï¼Œè™šæ‹ŸæœºåŠ è½½ç±»çš„æ—¶å€™ï¼Œæ˜¯é€šè¿‡ClassLoaderçš„loadClassæ–¹æ³•ï¼Œè€ŒloadClassæ–¹æ³•å¹¶ä¸æ˜¯finalç±»å‹çš„ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åˆ›å»ºè‡ªå·±çš„ç±»å»ç»§æ‰¿ClassLoaderï¼Œä»¥é‡è½½loadClassæ–¹æ³•å¹¶æ”¹å†™ç±»çš„åŠ è½½é€»è¾‘ï¼Œåœ¨éœ€è¦åŠ è½½PlugActivityçš„æ—¶å€™ï¼Œå·å·æŠŠå…¶æ¢æˆTargetActivityã€‚

å¤§è‡´æ€è·¯å¦‚ä¸‹

	public class CJClassLoader extends ClassLoader{

	@override
    public Class loadClass(String className){
      if(å½“å‰ä¸Šä¸‹æ–‡æ’ä»¶ä¸ä¸ºç©º) {
        if( className æ˜¯ TargetActivity){
             æ‰¾åˆ°å½“å‰å®é™…è¦åŠ è½½çš„åŸå§‹PlugActivityï¼ŒåŠ¨æ€åˆ›å»ºç±»ï¼ˆTargetActivity extends PlugActivity ï¼‰çš„dexæ–‡ä»¶
             return  ä»dexæ–‡ä»¶ä¸­åŠ è½½çš„TargetActivity
        }else{
             return  ä½¿ç”¨å¯¹åº”çš„PluginClassLoaderåŠ è½½æ™®é€šç±»
        }  
     }else{
         return super.loadClass() //ä½¿ç”¨åŸæ¥çš„ç±»åŠ è½½æ–¹æ³•
     }   
    } 
	}	
	
	
ä¸è¿‡è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸»é¡¹ç›®å¯åŠ¨æ’ä»¶Activityçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æ›¿æ¢Activityï¼Œä½†æ˜¯å¦‚æœåœ¨æ’ä»¶Activityï¼ˆæ¯”å¦‚MainActivityï¼‰å¯åŠ¨å¦ä¸€ä¸ªActivityï¼ˆSubActivityï¼‰çš„æ—¶å€™æ€ä¹ˆåŠï¼Ÿæ’ä»¶æ—¶æ™®é€šçš„ç¬¬ä¸‰æ–¹APKï¼Œæˆ‘ä»¬æ— æ³•æ›´æ”¹é‡Œé¢è·³è½¬Activityçš„é€»è¾‘ã€‚å…¶å®ï¼Œä»ä¸»é¡¹ç›®å¯åŠ¨æ’ä»¶MainActivityçš„æ—¶å€™ï¼Œå…¶å®å¯åŠ¨çš„æ˜¯æˆ‘ä»¬åŠ¨æ€åˆ›å»ºçš„TargetActivityï¼ˆextends MainActivityï¼‰ï¼Œè€Œæˆ‘ä»¬çŸ¥é“Activityå¯åŠ¨å¦ä¸€ä¸ªActivityçš„æ—¶å€™éƒ½æ˜¯ä½¿ç”¨å…¶â€œstartActivityForResultâ€æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨åˆ›å»ºTargetActivityæ—¶ï¼Œé‡å†™å…¶â€œstartActivityForResultâ€æ–¹æ³•ï¼Œè®©å®ƒåœ¨å¯åŠ¨å…¶ä»–Activityçš„æ—¶å€™ï¼Œä¹Ÿé‡‡ç”¨åŠ¨æ€åˆ›å»ºActivityçš„æ–¹å¼ï¼Œè¿™æ ·å°±èƒ½è§£å†³é—®é¢˜ã€‚


## æ€»ç»“
è¿«åˆ‡çš„éœ€æ±‚è¿«ä½¿æˆ‘ä»¬å¯»æ±‚æ–°çš„å‡ºè·¯ï¼Œè™½ç„¶å·²ç»æœ‰é«˜äººå¸®æˆ‘ä»¬é“ºè·¯ï¼Œä½†æ˜¯åœ¨å®ç°çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬è¿˜éš¾å…ä¼šé‡åˆ°å„ç§å„æ ·çš„é—®é¢˜ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ¡ˆé€‚ä¸é€‚åˆä½¿ç”¨ï¼Œä»¥åŠä½¿ç”¨å®ƒæ‰€å¸¦æ¥çš„ä»£ä»·æ˜¯å¦æˆ‘ä»¬å¯ä»¥æ‰¿å—çš„ï¼Œè¿˜éœ€å…·ä½“è€ƒé‡ï¼Œç›®å‰æ‰“ç®—åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ä¸€ä¸‹ï¼Œåšä¸€äº›ç°åº¦æµ‹è¯•.ç›®å‰çš„ç°çŠ¶æ˜¯åªæœ‰åœ¨å¤§å¤©æœæ‰æœ‰æ¯”è¾ƒæ·±å…¥çš„ç ”ç©¶å’Œåº”ç”¨ï¼Œç‰¹åˆ«æ˜¯ä¸€äº›SDKç»„ä»¶é¡¹ç›®å’Œ BATå®¶æ— çš„é¡¹ç›®ä¸Šï¼ŒGithubä¸Šçš„ç›¸å…³å¼€æºé¡¹ç›®åŸºæœ¬æ˜¯å›½äººåœ¨ç»´æŠ¤ï¼Œå¶å°”æœ‰å‡ ä¸ªå¤–å›½äººè¯·æ±‚æ›´æ–°è‹±æ–‡æ–‡æ¡£ã€‚


## æ‰©å±•ï¼ˆå¼€æºé¡¹ç›®ï¼‰
1. [DynamicLoadApk](https://github.com/singwhatiwanna/dynamic-load-apk)åŸç†æ˜¯ DexClassLoader åŠ  Activity ä»£ç†

2. [AndroidDynamicLoader](https://github.com/mmin18/AndroidDynamicLoader)è¿™æ˜¯ç‚¹è¯„ä¸€ä¸ªå·¥ç¨‹å¸ˆä»‹ç»çš„æ–¹å¼ï¼Œå’Œä¸Šé¢ä¸åŒçš„æ˜¯ï¼šä»–ä¸æ˜¯ç”¨ä»£ç† Activity çš„æ–¹å¼å®ç°è€Œæ˜¯ç”¨ Fragment ä»¥åŠ schema çš„æ–¹å¼å®ç°  
3. [Android PluginManager](https://github.com/houkx/android-pluginmgr
) å°±æ˜¯ä¸Šé¢æåˆ°çš„é»‘ç§‘æŠ€

4. [360 çš„ DroidPlugin](https://github.com/Qihoo360/DroidPlugin)

5. [æºç¨‹å®ç°æ–¹å¼](https://github.com/CtripMobile/DynamicAPK) æ˜¯é€šè¿‡ä¿®æ”¹ç¼–è¯‘å‚æ•°æ–¹å¼å®ç°çš„ï¼Œä¹Ÿæœ‰ç‚¹å„¿é»‘ç§‘æŠ€çš„å‘³é“ï¼Œä¹‹å‰æœ‰å¹¸å’Œä»–ä»¬çš„è´Ÿè´£äººèŠè¿‡å®ç°æ–¹å¼ï¼Œæ„Ÿè§‰éœ€è¦å¯¹æ˜¯androidç¼–è¯‘åŸç†æœ‰æ·±å…¥äº†è§£æ‰è¡Œ

6. [æ·˜å®çš„atlas](https://github.com/bunnyblue/ACDD) ä¸æ˜è§‰å‰



å‚è€ƒ :<br>

<https://mp.weixin.qq.com/s?__biz=MzAwMTcwNTE0NA==&mid=400217391&idx=1&sn=86181541ce0164156dfab135ed99bb5c&scene=1&srcid=1104k7DyMIQcy3dn4V92ej53&key=b28b03434249256b896f2f086a6011ab994d044aeae8d63c72c9fc3243ad1f93639d9aaf397de74b2b5038af885cf8d1&ascene=0&uin=OTIzMDExMjgx&devicetype=iMac+MacBookPro11%2C4+OSX+OSX+10.10.5+build(14F1605)&version=11020201&pass_ticket=ybD0d1rqopZeSSNMTp%2BfXFdMcdIKht194KS84io5O274qwxMUJPKWrMTnNshMNRK><br>
<http://mogu.io/117-117> <br>
<http://weishu.me/2016/01/28/understand-plugin-framework-overview/><br>
<https://segmentfault.com/a/1190000004062866><br>
<https://segmentfault.com/a/1190000004077469><br>
<http://blog.csdn.net/luoshengyang/article/details/6689748><br>
<https://www.zhihu.com/question/19981105>

<br>
<br>
<br>
<br>
<br>
==========

# Android hotfix
## å‰è¨€
åœ¨è½¯ä»¶å¼€å‘è¿‡ç¨‹æˆ‘ä»¬éš¾å…å‡ºç°å„ç§bug,å¯¹äºandroidåº”ç”¨æ¥è¯´å¦‚æœé‡åˆ°äº†ä¸¥é‡çš„bug,ä¿®å¤æµç¨‹ä¸€èˆ¬å¦‚ä¸‹:<br>
![icon](./process.png)<br>
ç„¶è€Œæˆ‘ä»¬å¯¹ç”¨æˆ·çš„å¯æ§æ€§å¾ˆå·®ï¼Œå¯¼è‡´æ–°ç‰ˆæœ¬è¦†ç›–ç‡å¾ˆéš¾æ§åˆ¶.è€Œä¸”é¢‘ç¹æ›´æ–°ç‰ˆæœ¬ä¼šä½¿ç”¨æˆ·å¯¹æˆ‘ä»¬APPçš„å°è±¡å˜å·®ï¼Œ[ä¸Šä¸€ç¯‡æ–‡](https://github.com/carl1990/Android-DynamicAPK-Plugin)æˆ‘ä»¬ä»‹ç»ä»‹ç»äº†androidåŠ è½½ç±»æ–‡ä»¶ä»¥åŠæ’ä»¶åŒ–å®ç°åŸç†ï¼Œä»Šå¤©ä¸»è¦è®²è§£ä¸€ä¸‹æ ¹æ®dexåˆ†åŒ…çš„æ–¹å¼å®ç°android bug hotfix.

## æŠ€æœ¯å®ç°

**æ€è·¯**<br>
æˆ‘ä»¬åªè¦æ‰¾åˆ°ï¼Œå‘ç”Ÿé—®é¢˜ç±»ï¼Œå¹¶ä¸”å°†å…¶æ›¿æ¢ä¸ºä¿®å¤åçš„ç±»å°±å¥½äº†<br>
![icon](./fix.png)<br>

**å®ç°**<br>

ä¸Šä¸€ç¯‡æˆ‘ä»¬åªæ˜¯è¯´åˆ°çš„äº†å¦‚ä½•åŠ è½½dexæ–‡ä»¶ï¼Œå¹¶æ²¡æœ‰æ¢å¯»Androidæ˜¯å¦‚ä½•åŠ è½½ç±»æ–‡ä»¶ï¼Œå€Ÿç”¨linuxä¹‹çˆ¶çš„åè¨€`â€œread the fucking source codeâ€`ï¼Œæ¥ä¸‹æ¥è¿˜æ˜¯çœ‹æºç å§

ç”±äº`DexClassLoader` ç»§æ‰¿è‡ª `BaseDexClassLoader` æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¯¥ç±»çš„æ„é€ æ–¹æ³•ï¼š

	public BaseDexClassLoader(String dexPath, File optimizedDirectory,
            String libraryPath, ClassLoader parent) {
        super(parent);
        this.pathList = new DexPathList(this, dexPath, libraryPath, 	optimizedDirectory);
	}

æ¥ä¸‹æ¥è¿›å…¥åˆ°`DexPathList` 

	public DexPathList(ClassLoader definingContext, String dexPath,
            String libraryPath, File optimizedDirectory) {
        if (definingContext == null) {
            throw new NullPointerException("definingContext == null");
        }
        if (dexPath == null) {
            throw new NullPointerException("dexPath == null");
        }
        if (optimizedDirectory != null) {
            if (!optimizedDirectory.exists())  {
                throw new IllegalArgumentException(
                        "optimizedDirectory doesn't exist: "
                        + optimizedDirectory);
            }
            if (!(optimizedDirectory.canRead()
                            && optimizedDirectory.canWrite())) {
                throw new IllegalArgumentException(
                        "optimizedDirectory not readable/writable: "
                        + optimizedDirectory);
            }
        }
        this.definingContext = definingContext;
        this.dexElements =
            makeDexElements(splitDexPath(dexPath), optimizedDirectory);
        this.nativeLibraryDirectories = splitLibraryPath(libraryPath);
    }
    
   è¿™é‡Œæä¸€ä¸‹ï¼Œandroid Dalvikå¹¶ä¸æ˜¯ç›´æ¥æ‰§è¡Œdexçš„ä»–ä¼šæŠŠdexæ–‡ä»¶ä¼˜åŒ–æˆ`ODEX`æ–‡ä»¶ï¼Œä»–æ¯”dexæ‹¥æœ‰æ›´é«˜çš„æ‰§è¡Œæ•ˆã€‚[æ›´å¤šå…³äºODEX](http://stackoverflow.com/questions/9593527/what-are-odex-files-in-android) è¿™é‡Œ`optimizedDirectory`ä¸‹é¢å†è®²æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œç»§ç»­çœ‹`makeDexElements`æ–¹æ³•
   
   	private static Element[] makeDexElements(ArrayList<File> files, File optimizedDirectory,
                                             ArrayList<IOException> suppressedExceptions) {
     // â€¦â€¦
        for (File file : files) {
            File zip = null;
            DexFile dex = null;
            String name = file.getName();
            if (name.endsWith(DEX_SUFFIX)) {   //.dexæ–‡ä»¶
                // Raw dex file (not inside a zip/jar).
                try {
                    dex = loadDexFile(file, optimizedDirectory);
                } catch (IOException ex) {
                    System.logE("Unable to load dex file: " + file, ex);
                }
            } else if (name.endsWith(APK_SUFFIX) || name.endsWith(JAR_SUFFIX)
                    || name.endsWith(ZIP_SUFFIX)) {
                    //.apk  .jar  .zipæ–‡ä»¶
                zip = file;
                try {
                    dex = loadDexFile(file, optimizedDirectory);
                } catch (IOException suppressed) {
                    suppressedExceptions.add(suppressed);
                }
            } else if (file.isDirectory()) {
                // We support directories for looking up resources.
                // This is only useful for running libcore tests.
                elements.add(new Element(file, true, null, null));
            } else {
                System.logW("Unknown file type for: " + file);
            }
        }
                    //â€¦â€¦
        return elements.toArray(new Element[elements.size()]);
    }

   	
   	
ç»§ç»­å‘ä¸‹çœ‹

	private static DexFile loadDexFile(File file, File optimizedDirectory)
            throws IOException {
        if (optimizedDirectory == null) {
            return new DexFile(file);
        } else {
            String optimizedPath = optimizedPathFor(file, optimizedDirectory);
            return DexFile.loadDex(file.getPath(), optimizedPath, 0);
        }
    }
    
    
 ä¸‹é¢å°±æ˜¯`optimizedPathFor`æ–¹æ³•äº†
 
 	private static String optimizedPathFor(File path,
            File optimizedDirectory) {
        String fileName = path.getName();
        if (!fileName.endsWith(DEX_SUFFIX)) {
            int lastDot = fileName.lastIndexOf(".");
            if (lastDot < 0) {
                fileName += DEX_SUFFIX;
            } else {
                StringBuilder sb = new StringBuilder(lastDot + 4);
                sb.append(fileName, 0, lastDot);
                sb.append(DEX_SUFFIX);
                fileName = sb.toString();
            }
        }
        File result = new File(optimizedDirectory, fileName);
        return result.getPath();
    }




optimizedPathForä¸»è¦æ˜¯å¯¹æ–‡ä»¶çš„åç¼€è¿›è¡Œä¿®æ­£ï¼Œå¦‚æœæ²¡æœ‰åç¼€åï¼Œå°±åœ¨æœ«å°¾åŠ ä¸Š.dexï¼Œå¦‚æœæ–‡ä»¶ç»“å°¾ä¸æ˜¯.dexï¼Œå°±å°†åç¼€æ›¿æ¢ä¸º.dexï¼Œç„¶ååˆ›å»ºæˆ‘ä»¬çš„.dexæ–‡ä»¶ï¼Œç„¶åè¿”å›æˆ‘ä»¬åˆ›å»ºçš„.dexæ–‡ä»¶çš„è·¯å¾„ï¼Œç»§ç»­æ‰§è¡ŒDexFile.loadDex() å‡½æ•°

å¥½äº†åˆ°è¿™é‡Œæˆ‘ä»¬ä¸åœ¨ç»§ç»­å¾€ä¸‹çœ‹äº†ï¼Œä½†æ˜¯æˆ‘ä»¬å·²ç»çŸ¥é“äº†æ‰€æœ‰çš„dexæœ€ç»ˆéƒ½å­˜å‚¨åœ¨äº†`Element[]`ä¸­ã€‚

è§£ä¸‹æ¥ï¼Œå°±æ˜¯æ‰¾åˆ°åœ¨ä½¿ç”¨ã€åŠ è½½è¯¥æ–‡ä»¶çš„æ—¶å€™å»æŸ¥æ‰¾è¯¥è¯¥æ–‡ä»¶äº†ï¼Œå°±æ˜¯åœ¨`DexPathList`ä¸­çš„`findClass()`æ–¹æ³•ä¸­

	 /**
     * Finds the named class in one of the dex files pointed at by
     * this instance. This will find the one in the earliest listed
     * path element. If the class is found but has not yet been
     * defined, then this method will define it in the defining
     * context that this instance was constructed with.
     *
     * @return the named class or {@code null} if the class is not
     * found in any of the dex files
     */
    public Class findClass(String name) {
        for (Element element : dexElements) {
            DexFile dex = element.dexFile;
            if (dex != null) {
                Class clazz = dex.loadClassBinaryName(name, definingContext);
                if (clazz != null) {
                    return clazz;
                }
            }
        }
        return null;
    }
    
å®ƒå›å»éå†æˆ‘ä»¬ä¹‹å‰å­˜å‚¨è¿›å»çš„dex,åœ¨ä»–çš„æ³¨é‡Šä¸­æ³¨é‡Šè¯´çš„å¾ˆæ¸…æ¥šï¼šä¼šé¦–å…ˆåŠ è½½ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„ç±»ï¼š<br>
![select](./select.jpg)
é‚£ä¹ˆæˆ‘çš„ä¿®å¤æ–¹æ¡ˆå°±æ˜¯æŠŠpatch.dexï¼Œæ’å…¥åˆ°elmentsæ•°ç»„çš„æœ€å‰é¢å°±å¥½
![select](./fix.jpg)

**è¿™ä¸ªæ—¶å€™ä½ ä¸€å®šä»¥ä¸ºå®Œäº‹äº†ï¼Œå“ˆå“ˆ `too young too native`**

è¿™ä¸ªæ—¶å€™ä¼šæŠ¥ä¸€ä¸ª

	java.lang.IllegalAccessError: Class ref in pre-verified class resolved to unexpected implementation
	é”™è¯¯
	
google ä¸€ä¸‹,å‘ç°è¿™æ˜¯ç”±äº[DexPrepare.cpp](https://android.googlesource.com/platform/dalvik/+/3740ab6c5b5544e26acb257bc092415b48bdef63/vm/analysis/DexPrepare.cpp)åœ¨å°†Dexè½¬åŒ–ä¸ºODexè¿‡ç¨‹ä¸­[DexVerify.cpp](https://android.googlesource.com/platform/dalvik.git/+/android-4.3_r3/vm/analysis/DexVerify.cpp)ä¸­è¿›è¡Œæ ¡éªŒï¼ŒéªŒè¯å¦‚æœç›´æ¥å¼•ç”¨åˆ°çš„ç±»å’Œclazzæ˜¯å¦åœ¨åŒä¸€ä¸ªDexï¼Œå¦‚æœæ˜¯åˆ™ä¼šæ‰“ä¸ŠCLASS_ISPREVERIFIEDæ ‡å¿—

	è™šæ‹Ÿæœºåœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šæœ‰è®¸å¤šçš„å¯åŠ¨å‚æ•°ï¼Œå…¶ä¸­ä¸€é¡¹å°±æ˜¯verifyé€‰é¡¹ï¼Œå½“verifyé€‰é¡¹è¢«æ‰“å¼€çš„æ—¶å€™ï¼Œå°±ä¼šæ‰§è¡ŒdvmVerifyClassè¿›è¡Œç±»çš„æ ¡éªŒï¼Œå¦‚æœdvmVerifyClassæ ¡éªŒç±»æˆåŠŸï¼Œé‚£ä¹ˆè¿™ä¸ªç±»ä¼šè¢«æ‰“ä¸ŠCLASS_ISPREVERIFIEDçš„æ ‡å¿—ã€‚
	
	æ€ä¹ˆæ ·ç®—æ˜¯æ ¡éªŒç±»æˆåŠŸï¼Ÿå¦‚æœstaticæ–¹æ³•ã€privateæ–¹æ³•ã€æ„é€ å‡½æ•°ç­‰ï¼Œå…¶ä¸­çš„ç›´æ¥å¼•ç”¨ï¼ˆç¬¬ä¸€å±‚å…³ç³»ï¼‰åˆ°çš„ç±»éƒ½åœ¨åŒä¸€ä¸ªDexæ–‡ä»¶ä¸­ï¼Œé‚£ä¹ˆè¯¥ç±»å°±ä¼šè¢«æ‰“ä¸ŠCLASS_ISPREVERIFIEDæ ‡å¿—
	
	æˆ‘ä»¬è¦åšçš„å°±æ˜¯ï¼Œé˜»æ­¢è¯¥ç±»æ‰“ä¸ŠCLASS_ISPREVERIFIEDçš„æ ‡å¿—ã€‚å¦åˆ™åŠ è½½å…¶ä»–Dexçš„æ—¶å€™ä¼šæŠ¥é”™ã€‚
	æ³¨æ„ä¸‹ï¼Œæ˜¯é˜»æ­¢å¼•ç”¨è€…çš„ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå‡è®¾ä½ çš„appé‡Œé¢æœ‰ä¸ªç±»å«åšLoadBugClassï¼Œå†å…¶å†…éƒ¨å¼•ç”¨äº†BugClassã€‚å‘å¸ƒè¿‡ç¨‹ä¸­å‘ç°BugClassæœ‰ç¼–å†™é”™è¯¯ï¼Œé‚£ä¹ˆæƒ³è¦å‘å¸ƒä¸€ä¸ªæ–°çš„BugClassç±»ï¼Œé‚£ä¹ˆä½ å°±è¦é˜»æ­¢LoadBugClassè¿™ä¸ªç±»æ‰“ä¸ŠCLASS_ISPREVERIFIEDçš„æ ‡å¿—ã€‚
	
	ä½ åœ¨ç”Ÿæˆapkä¹‹å‰ï¼Œå°±éœ€è¦é˜»æ­¢ç›¸å…³ç±»æ‰“ä¸ŠCLASS_ISPREVERIFIEDçš„æ ‡å¿—äº†ã€‚å¯¹äºå¦‚ä½•é˜»æ­¢ï¼Œå¯è®©LoadBugClassåœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œå»å¼•ç”¨åˆ«çš„dexæ–‡ä»¶ï¼Œæ¯”å¦‚ï¼šhack.dexä¸­çš„æŸä¸ªç±»å³å¯ã€‚
	
	
åŸºäºä»¥ä¸ŠæŠ€æœ¯å¼€æºå‡ºæ¥çš„

1. [dodola/HotFix](https://github.com/dodola/HotFix )   (ç™¾åº¦å®ç°)
2. [jasonross/Nuwa](https://github.com/jasonross/Nuwa)  (ç‚¹è¯„å®ç°)
3. [DroidFix](https://github.com/bunnyblue/DroidFix)


## å…¶ä»–æ–¹å¼
 
### Dexposed 
[Dexposed](https://github.com/alibaba/dexposed) æ˜¯é˜¿é‡ŒåŸºäº `rovo89/Xposed`(å¯¹äºè¿™ä¸ªæ¡†æ¶ä¸æ˜¯å¾ˆäº†è§£)çš„AOPæ¡†æ¶ æ–¹æ³•çº§åˆ«ç²’åº¦ï¼Œè€Œä¸”ä¸ä»…å¯ä»¥Hot Fixï¼Œè¿˜å¯è¿›è¡ŒAOPç¼–ç¨‹ã€æ’æ¡©ã€Hookç­‰åŠŸèƒ½ã€‚

Xposedæ˜¯éœ€è¦ROOTæƒé™ï¼Œå› ä¸ºå…¶è¦ä¿®æ”¹å…¶ä»–åº”ç”¨åŠç³»ç»Ÿè¡Œä¸ºï¼Œè€Œå¯¹äºå•ä¸ªåº”ç”¨è€Œè¨€ï¼Œä¸éœ€è¦ROOTã€‚XposedåŸºæœ¬åŸç†æ˜¯ï¼šé€šè¿‡ä¿®æ”¹Dalvikè¿è¡Œæ—¶çš„Zygoteè¿›ç¨‹ï¼Œä½¿ç”¨Xposed Bridgeæ¥hookæ–¹æ³•å¹¶æ³¨å…¥è‡ªèº«ä»£ç ï¼Œå®ç°éä¾µå…¥å¼çš„Runtimeä¿®æ”¹ã€‚åŒ…æ‹¬å°ç±³ï¼ˆonVmCreatedæ–¹æ³•ï¼‰ï¼Œä¹Ÿåˆ©ç”¨æ­¤ç‰¹æ€§ï¼Œåšäº†è‡ªå®šä¹‰ä¸»é¢˜ã€æ²‰æµ¸å¼çŠ¶æ€æ ç­‰åŠŸèƒ½ã€‚

åº”ç”¨å¯åŠ¨æ—¶ï¼Œä¼šfork zygoteè¿›ç¨‹ï¼Œè£…è½½classå’Œinvokeå„ç§åˆå§‹åŒ–æ–¹æ³•ï¼ŒXposedå°±æ˜¯åœ¨è¿™ä¸ªè¿‡ç¨‹æ›¿æ¢äº†app_processï¼Œhookå„ä¸ªå…¥å£æ–¹æ³•ï¼ŒåŠ è½½XposedBridge.jaræä¾›åŠ¨æ€hookåŸºç¡€ï¼Œå…·ä½“æŸ¥çœ‹XposedBridgeã€‚

å…·ä½“çš„Nativeå®ç°åˆ™æ˜¯åœ¨libxposed_common.cppé‡Œé¢ï¼Œæ ¹æ®ç³»ç»Ÿç‰ˆæœ¬è¿›è¡Œåˆ†å‘åˆ°libxposed_dalvikæˆ–libxposed_artï¼Œè®°å½•ä¸‹åŸæ¥æ–¹æ³•ä¿¡æ¯ï¼Œå°†æ–¹æ³•æŒ‡é’ˆæŒ‡å‘hookedMethodCallbackï¼Œä»è€Œè¾¾åˆ°åŠ«æŒç›®çš„ã€‚
æ­¤æ–¹å¼åªèƒ½å¯¹JAVAæ–¹æ³•åšæ‹¦æˆªï¼Œä¸æ”¯æŒCæ–¹æ³•ã€‚å¦‚æœçº¿ä¸ŠRELEASEç‰ˆæœ¬è¿›è¡Œæ··æ·†ï¼Œpatchä¹Ÿæ˜¯ä¸€ä¸ªç—›è‹¦äº‹æƒ…ï¼Œåå°„å’Œå†…éƒ¨ç±»ã€åŒ…åå’Œå†…éƒ¨ç±»å†²çªç­‰å¤„ç†å¾ˆç¹çã€‚

### AndFix
[AndFix](https://github.com/alibaba/AndFix) ä¹Ÿæ˜¯é˜¿é‡Œå®ç°çš„
ç®€å•æ¥è¯´ï¼Œä¸»è¦é€šè¿‡è¡¥ä¸å·¥å…·ï¼Œåˆ©ç”¨æ³¨è§£ç­‰ï¼Œæè¿°å…¶ä¸è¦æ‰“è¡¥ä¸çš„ç±»å’Œæ–¹æ³•çš„å¯¹åº”å…³ç³»ï¼Œä¹‹ååœ¨åº”ç”¨ä¸­ï¼ŒåŠ è½½å¹¶æ›¿æ¢æ–¹æ³•çš„ä¿¡æ¯å’ŒæŒ‡é’ˆï¼Œä»è€Œè¾¾åˆ°çƒ­ä¿®å¤ç›®çš„ã€‚é‡Œé¢çš„å®ç°å¯èƒ½è¿˜æ¶‰åŠåˆ°å…¶ä»–çš„éƒ¨åˆ†ï¼Œæ¯”å¦‚Securityæ£€æŸ¥ã€PATCHè¦†ç›–ç­‰,æ›´åŠ è¯¦ç»†çš„å†…å®¹è¯·å’ŒåŸç†è¯·æŸ¥çœ‹[Androidçƒ­è¡¥ä¸ä¹‹AndFixåŸç†è§£æ](http://w4lle.github.io/2016/03/03/Android%E7%83%AD%E8%A1%A5%E4%B8%81%E4%B9%8BAndFix%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/)

### å¯¹æ¯”

1. Dexposedä¸æ”¯æŒArtæ¨¡å¼ï¼ˆ5.0+ï¼‰ï¼Œä¸”å†™è¡¥ä¸æœ‰ç‚¹å›°éš¾ï¼Œéœ€è¦åå°„å†™æ··æ·†åçš„ä»£ç ï¼Œç²’åº¦å¤ªç»†ï¼Œè¦æ›¿æ¢çš„æ–¹æ³•å¤šçš„è¯ï¼Œå·¥ä½œé‡ä¼šæ¯”è¾ƒå¤§ã€‚
2.  AndFixæ”¯æŒ2.3-6.0ï¼Œä½†æ˜¯ä¸æ¸…æ¥šæ˜¯å¦æœ‰ä¸€äº›æœºå‹çš„å‘åœ¨é‡Œé¢ï¼Œæ¯•ç«Ÿjniå±‚ä¸åƒjavaæ›¾ä¸€æ ·æ ‡å‡†ï¼Œä»å®ç°æ¥è¯´ï¼Œæ–¹æ³•ç±»ä¼¼Dexposedï¼Œéƒ½æ˜¯é€šè¿‡jniæ¥æ›¿æ¢æ–¹æ³•ï¼Œä½†æ˜¯å®ç°ä¸Šæ›´ç®€æ´ç›´æ¥ï¼Œåº”ç”¨patchä¸éœ€è¦é‡å¯ã€‚ä½†ç”±äºä»å®ç°ä¸Šç›´æ¥è·³è¿‡äº†ç±»åˆå§‹åŒ–ï¼Œè®¾ç½®ä¸ºåˆå§‹åŒ–å®Œæ¯•ï¼Œæ‰€ä»¥åƒæ˜¯é™æ€å‡½æ•°ã€é™æ€æˆå‘˜ã€æ„é€ å‡½æ•°éƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œå¤æ‚ç‚¹çš„ç±»Class.fornameå¾ˆå¯èƒ½ç›´æ¥å°±ä¼šæŒ‚æ‰
3.  åˆ†åŒ…æ–¹æ¡ˆæ–¹æ¡ˆæ”¯æŒ2.3-6.0ï¼Œä¼šå¯¹å¯åŠ¨é€Ÿåº¦ç•¥å¾®æœ‰å½±å“ï¼Œåªèƒ½åœ¨ä¸‹ä¸€æ¬¡åº”ç”¨å¯åŠ¨æ—¶ç”Ÿæ•ˆï¼Œåœ¨ç©ºé—´ä¸­å·²ç»æœ‰äº†è¾ƒé•¿æ—¶é—´çš„çº¿ä¸Šåº”ç”¨ï¼Œå¦‚æœå¯ä»¥æ¥å—åœ¨ä¸‹æ¬¡å¯åŠ¨æ‰åº”ç”¨è¡¥ä¸ï¼Œæ˜¯å¾ˆå¥½çš„é€‰æ‹©ã€‚

æ€»ä½“ä¸Šæ¥è¯´ï¼š**åˆ†åŒ…æ–¹æ¡ˆæ–¹æ¡ˆ**æ¯”è¾ƒå¯é è€Œä¸”åœ¨QZoneä¸­åº”ç”¨äº†å¾ˆä¹…äº†ï¼Œä¸”å®ç°ç®€å•ï¼Œå”¯ä¸€çš„é—®é¢˜å°±æ˜¯éœ€è¦ä¸‹æ¬¡å¯åŠ¨patch æ‰ä¼šåº”ç”¨



#### å‚è€ƒ
[å„å¤§çƒ­è¡¥ä¸æ–¹æ¡ˆåˆ†æå’Œæ¯”è¾ƒ](http://blog.zhaiyifan.cn/2015/11/20/HotPatchCompare/)<br>
[æµ…ædexæ–‡ä»¶åŠ è½½æœºåˆ¶](http://www.cnblogs.com/lanrenxinxin/p/4712224.html)<br>
[QQç©ºé—´çƒ­è¡¥ä¸åŠ¨æ€ä¿®å¤æŠ€æœ¯](https://zhuanlan.zhihu.com/p/20308548)<br>
[HotFix](https://github.com/dodola/HotFix )<br>
[Nuwa](https://github.com/jasonross/Nuwa)<br> 
[DroidFix](https://github.com/bunnyblue/DroidFix)<br>

